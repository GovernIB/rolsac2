name: Set Start Date in GitHub Project
on:
  issues:
    types: [opened]

jobs:
  update-project-field:
    runs-on: ubuntu-latest
    steps:
      - name: Set Start Date in GitHub Project
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.ORG_PAT }}
          script: |
            const { owner, repo } = context.repo;
            const issueId = context.payload.issue.node_id;
            const projectNumber = 55;  
            const fieldName = "Start date";

            // Obtener la fecha actual en formato YYYY-MM-DD
            const startDate = new Date().toISOString().split("T")[0];

            const query = `
              query($org: String!, $projectNumber: Int!) {
                organization(login: $org) {
                  projectV2(number: $projectNumber) {
                    id
                    fields(first: 20) {
                      nodes {
                        ... on ProjectV2Field {
                          id
                          name
                        }
                      }
                    }
                  }
                }
              }`;
            
            const variables = { org: "GovernIB", projectNumber: 55 };
            const result = await github.graphql(query, variables);

            console.log("üîç Resultado de la consulta GraphQL:", JSON.stringify(result, null, 2));
            
            if (!result.organization || !result.organization.projectV2) {
              throw new Error(`‚ùå No se encontr√≥ el proyecto con n√∫mero ${projectNumber} en la organizaci√≥n 'GovernIB'`);
            }
            
            const projectId = result.organization.projectV2.id;            
            const field = result.organization.projectV2.fields.nodes.find(f => f.name === fieldName);

            if (!field) {
              throw new Error(`‚ùå No se encontr√≥ el campo personalizado: ${fieldName}`);
            }

            const fieldId = field.id;

            // 2Ô∏è‚É£ Agregar la issue al proyecto si no est√° ya en √©l
            const addItemMutation = `
              mutation($projectId: ID!, $issueId: ID!) {
                addProjectV2ItemById(input: {projectId: $projectId, contentId: $issueId}) {
                  item {
                    id
                  }
                }
              }`;

            const addItemResult = await github.graphql(addItemMutation, { projectId, issueId });
            const itemId = addItemResult.addProjectV2ItemById.item.id;

            // 3Ô∏è‚É£ Actualizar el campo `startDate`
            const updateFieldMutation = `
              mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $startDate: String!) {
                updateProjectV2ItemFieldValue(input: {projectId: $projectId, itemId: $itemId, fieldId: $fieldId, value: {text: $startDate}}) {
                  projectV2Item {
                    id
                  }
                }
              }`;

            await github.graphql(updateFieldMutation, { projectId, itemId, fieldId, startDate });

            console.log(`‚úÖ Campo '${fieldName}' actualizado con fecha: ${startDate}`);
