<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:p="http://primefaces.org/ui"
      xmlns:my="http://java.sun.com/jsf/composite/components">
<ui:composition template="/WEB-INF/templates/layoutDialog.xhtml">
    <ui:define name="metadata">
        <f:metadata>
            <f:viewParam id="MODO_ACCESO" name="MODO_ACCESO" value="#{dialogNormativa.modoAcceso}"/>
            <f:viewParam id="ID" name="ID" value="#{dialogNormativa.id}"/>
            <f:viewAction action="#{dialogNormativa.load}"/>
        </f:metadata>
    </ui:define>
    <ui:define name="pageTitleDialog">
        <h:outputFormat value="#{labels['dialogNormativa.consulta']}"
                        rendered="#{dialogNormativa.isModoConsulta()}"/>
        <h:outputFormat value="#{labels['dialogNormativa.detalle']}"
                        rendered="#{dialogNormativa.isModoEdicion()}"/>
        <h:outputFormat value="#{labels['dialogNormativa.nuevo']}"
                        rendered="#{dialogNormativa.isModoAlta()}"/>
    </ui:define>
    <ui:define name="contentIdioma">

        <span class="pi pi-tag mt-1"/>
        <h:outputText value="#{labels['dict.idioma']}:" styleClass="mr-1 mt-1"/>
        <p:selectOneButton id="opcionIdioma" value="#{dialogNormativa.idioma}" styleClass="botoneraRed"
                           unselectable="false">
            <f:selectItems value="#{sessionBean.getIdiomasPermitidosList()}" var="idioma"
                           itemValue="#{idioma}" itemLabel="#{labels['idiomas.' += idioma]}"/>
            <p:ajax update="formDialog:txtNombre formDialog:dataDocumentosRelacionados formDialog:txtUrlBoletin
            formDialog:dataTableUAs formDialog:dataProcedimientosRelacionados formDialog:dataAfectacionesRelacionadas"
                    process="@this"/>
        </p:selectOneButton>
        <p:commandButton action="#{dialogNormativa.traducir}"
                         icon="pi pi-compass" iconPos="top"
                         value="#{labels['dict.traducir']}"
                         style="margin-left:10px"
                         update="messagesDialog"
                         process="@this"
                         rendered="#{!dialogNormativa.isModoConsulta() and dialogNormativa.tradExiste()}">
            <p:ajax event="dialogReturn" listener="#{dialogNormativa.returnDialogTraducir}" process="@this"
                    update="formDialog:txtNombre formDialog:txtUrlBoletin"/>
        </p:commandButton>
    </ui:define>
    <ui:define name="contentDialog">
        <p:growl id="messagesDialog"
                 globalOnly="false"
                 showDetail="false"
                 life="5000"
                 escape="false"/>
        <div class="ui-g-12 ui-md-8 pl-4 panel-container">
            <p:panel id="formDatos" header="#{labels['dialogNormativa.datos']}">
                <div class="form-row">
                    <div class="form-group col-md-10">
                        <p:outputLabel styleClass="mr-2 mb-1 pt-0" value="#{labels['dialogNormativa.titulo']}:"
                                       for="txtNombre"/>
                        <my:literalComponent id="txtNombre"
                                             literal="#{dialogNormativa.data.nombre}"
                                             soloLecture="#{dialogNormativa.isModoConsulta()}"
                                             required="#{empty param['formDialog:closeButton']}"
                                             idioma="#{dialogNormativa.idioma}"
                                             idiomasObligatorios="#{sessionBean.getIdiomasObligatorios()}"
                                             idiomasPermitidos="#{sessionBean.getIdiomasPermitidos()}"
                                             nombreLiteral="#{labels['dict.titulo']}">
                            <f:validator validatorId="es.caib.rolsac2.back.validators.ValidadorLiteral"/>
                        </my:literalComponent>
                    </div>
                    <div class="form-group col-md-2">
                        <p class="mb-1">
                            <h:outputText value="#{labels['dict.codigo']}:" for="txtCodigo"/>
                        </p>
                        <p:inputText id="txtCodigo" value="#{dialogNormativa.data.codigo}"
                                     styleClass="w95" disabled="true" maxlength="50"/>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group col-md-4">
                        <p:outputLabel styleClass="mr-2 mb-1 pt-0" value="#{labels['dialogNormativa.tipoNormativa']}:"
                                       for="selectTipoNormativa"/>
                        <p:selectOneMenu id="selectTipoNormativa" value="#{dialogNormativa.data.tipoNormativa}"
                                         styleClass="w95" required="#{empty param['formDialog:closeButton']}"
                                         requiredMessage="#{labels['dict.obligatorio.tipoNormativa']}"
                                         disabled="#{dialogNormativa.isModoConsulta()}"
                                         converter="#{tipoNormativaConverter}">
                            <f:selectItem itemLabel="#{labels['dialogNormativa.selecciona.tipoNormativa']}"
                                          itemValue="#{null}"/>
                            <f:selectItems value="#{dialogNormativa.tipoNormativa}" var="tipoNormativa"
                                           itemLabel="#{tipoNormativa.descripcion.getTraduccion(dialogNormativa.idioma)}"
                                           itemValue="#{tipoNormativa}"/>
                            <p:ajax event="change" update="@this"></p:ajax>
                        </p:selectOneMenu>
                    </div>
                    <div class="form-group col-md-4">
                        <p class="mb-1">
                            <h:outputText value="#{labels['dialogNormativa.numero']}:" for="txtNumero"/>
                        </p>
                        <p:inputText id="txtNumero" value="#{dialogNormativa.data.numero}"
                                     styleClass="w95" disabled="#{dialogNormativa.isModoConsulta()}" maxlength="50"
                        />
                    </div>
                    <div class="form-group col-md-4">
                        <p class="mb-0">
                            <p:outputLabel styleClass="mr-2 mb-1 pt-0"
                                           value="#{labels['dialogNormativa.fechaAprobacion']}:"
                                           for="txtFechaAprobacion"/>
                        </p>
                        <p:calendar id="txtFechaAprobacion" disabled="#{dialogNormativa.isModoConsulta()}"
                                    requiredMessage="#{labels['dict.obligatorio.fechaAprobacion']}"
                                    required="#{empty param['formDialog:closeButton']}" showOn="button"
                                    value="#{dialogNormativa.data.fechaAprobacion}" pattern="dd/MM/yyyy"/>
                    </div>
                </div>
            </p:panel>
            <p:panel id="formPublicacion" header="#{labels['dialogNormativa.datosPublicacion']}">
                <div class="form-row">
                    <div class="form-group col-md-4">

                        <p:outputLabel styleClass="mr-2 mb-1 pt-0"
                                       value="#{labels['dialogNormativa.boletinOficial']}:"
                                       for="selectBoletinOficial"/>

                        <p:selectOneMenu id="selectBoletinOficial" value="#{dialogNormativa.data.boletinOficial}"
                                         styleClass="w95" required="#{empty param['formDialog:closeButton']}"
                                         requiredMessage="#{labels['dict.obligatorio.boletinOficial']}"
                                         disabled="#{dialogNormativa.isModoConsulta()}"
                                         converter="#{boletinOficialConverter}">
                            <f:selectItem itemLabel="#{labels['dialogNormativa.selecciona.boletinOficial']}"
                                          itemValue="#{null}"/>
                            <f:selectItems value="#{dialogNormativa.tipoBoletin}" var="boletinOficial"
                                           itemLabel="#{boletinOficial.nombre}" itemValue="#{boletinOficial}"/>
                        </p:selectOneMenu>
                    </div>
                    <div class="form-group col-md-4">
                        <p:outputLabel value="#{labels['dialogNormativa.numeroBoletin']}:" for="txtNumeroBoletin" styleClass="mr-2 mb-1 pt-0"/>
                        <p:inputText id="txtNumeroBoletin" value="#{dialogNormativa.data.numeroBoletin}"
                                     styleClass="w95"
                                     disabled="#{dialogNormativa.isModoConsulta()}" maxlength="50"/>
                    </div>
                    <div class="form-group col-md-4">
                        <p class="mb-1">
                            <h:outputText styleClass="mb-1" value="#{labels['dialogNormativa.fechaBoletin']}:"
                                          for="txtFechaBoletin"/>
                        </p>
                        <p:calendar id="txtFechaBoletin" disabled="#{dialogNormativa.isModoConsulta()}"
                                    value="#{dialogNormativa.data.fechaBoletin}" pattern="dd/MM/yyyy" showOn="button"/>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group col-md-12">

                        <p:outputLabel styleClass="mr-2 mb-1 pt-0" value="#{labels['dialogNormativa.urlBoletin']}:"
                                       for="txtUrlBoletin"/>

                        <my:literalComponent id="txtUrlBoletin"
                                             literal="#{dialogNormativa.data.urlBoletin}"
                                             soloLecture="#{dialogNormativa.isModoConsulta()}"
                                             required="#{empty param['formDialog:closeButton']}"
                                             idioma="#{dialogNormativa.idioma}"
                                             idiomasObligatorios="#{sessionBean.getIdiomasObligatorios()}"
                                             idiomasPermitidos="#{sessionBean.getIdiomasPermitidos()}"
                                             nombreLiteral="#{labels['dialogNormativa.urlBoletin']}">
                            <f:validator validatorId="es.caib.rolsac2.back.validators.ValidadorLiteral"/>
                        </my:literalComponent>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group col-md-12">
                        <p class="mb-1">
                            <h:outputText value="#{labels['dialogNormativa.nombreResponsable']}:"
                                          for="txtNombreResponsable"/>
                        </p>
                        <my:literalComponent id="txtNombreResponsable"
                                             literal="#{dialogNormativa.data.nombreResponsable}"
                                             soloLecture="#{dialogNormativa.isModoConsulta()}"
                                             required="#{empty param['formDialog:closeButton']}"
                                             idioma="#{dialogNormativa.idioma}"
                                             idiomasObligatorios="#{sessionBean.getIdiomasObligatorios()}"
                                             idiomasPermitidos="#{sessionBean.getIdiomasPermitidos()}"
                                             nombreLiteral="#{labels['dialogNormativa.nombreResponsable']}"/>
                    </div>
                </div>
            </p:panel>
        </div>
        <div class="ui-g-12 ui-md-4 pr-1">
            <div class="row left-container mx-0 mb-2">
                <div class="col-12 left-container-header text-center">
                    <p class="left-container-tit mt-2 mb-1">#{labels['dialogNormativa.documentos']}</p>
                </div>
                <div class="col-10 p-1">
                    <p:dataTable id="dataDocumentosRelacionados"
                                 var="doc"
                                 value="#{dialogNormativa.data.documentosNormativa}"
                                 emptyMessage="#{labels['dict.noHayDatos']}"
                                 scrollable="true" scrollHeight="120"
                                 paginator="false"
                                 styleClass="noHeader text-center"
                                 selectionMode="single"
                                 selection="#{dialogNormativa.documentoRelacionadoSeleccionado}"
                                 rowKey="#{doc.codigoTabla}">

                        <!-- Necesario para actualizar en controlador la fila seleccionada -->
                        <p:ajax
                                event="rowDblselect"
                                oncomplete="triggerDblClickDoc();"
                                global="false"/>
                        <p:ajax event="rowSelect" global="false"/>
                        <p:ajax event="rowSelect" global="false"/>
                        <p:ajax event="rowUnselect"/>


                        <p:column styleClass="w75">
                            <h:outputText value="#{doc.titulo.getTraduccion(dialogNormativa.idioma)}"/>
                        </p:column>

                    </p:dataTable>
                </div>
                <div class="col-2 p-1 d-flex flex-column align-content-center justify-content-center align-items-center">
                    <p:commandButton title="#{labels['dict.nuevo']}" process="@this"
                                     actionListener="#{dialogNormativa.abrirDocumentoRelacionado()}" icon="pi pi-plus"
                                     styleClass="text-success" rendered="#{!dialogNormativa.isModoConsulta()}">
                        <!--Ajax para coger el return del dialog-->
                        <p:ajax event="dialogReturn" listener="#{dialogNormativa.returnDialogoDocumento}"
                                update="formDialog:dataDocumentosRelacionados"/>
                    </p:commandButton>
                    <p:commandButton title="#{labels['dict.eliminar']}" process="@this"
                                     actionListener="#{dialogNormativa.borrarDocumentoRelacionado()}" icon="pi pi-minus"
                                     styleClass="text-danger" rendered="#{!dialogNormativa.isModoConsulta()}"
                                     update="formDialog:dataDocumentosRelacionados">
                    </p:commandButton>
                    <p:commandButton title="#{labels['dict.consultar']}" process="@this"
                                     actionListener="#{dialogNormativa.consultarDocumentoRelacionado()}"
                                     icon="pi pi-eye" rendered="#{dialogNormativa.isModoConsulta()}">
                        <p:ajax event="dialogReturn" listener="#{dialogNormativa.returnDialogoDocumento}"
                                update="formDialog:dataDocumentosRelacionados"/>
                    </p:commandButton>
                    <p:commandButton id="btnEditarDoc" title="#{labels['dict.editar']}" process="@this"
                                     actionListener="#{dialogNormativa.editarDocumentoRelacionado()}"
                                     icon="pi pi-pencil" rendered="#{!dialogNormativa.isModoConsulta()}">
                        <p:ajax event="dialogReturn" listener="#{dialogNormativa.returnDialogoDocumento}"
                                update="formDialog:dataDocumentosRelacionados"/>
                    </p:commandButton>

                </div>
            </div>
            <div class="row left-container mx-0 mb-2">
                <div class="col-12 left-container-header text-center">
                    <p class="left-container-tit mt-2 mb-1">#{labels['dialogNormativa.uaRelacionadas']}</p>
                </div>
                <div class="col-10 p-1">
                    <p:dataTable id="dataTableUAs" var="td" value="#{dialogNormativa.data.unidadesAdministrativas}"
                                 emptyMessage="#{labels['dict.tablaVacia']}" scrollable="true" scrollHeight="120"
                                 paginator="false" selectionMode="single"
                                 selection="#{dialogNormativa.uaSeleccionada}"
                                 rowKey="#{td.codigo}" styleClass="noHeader"
                    >

                        <!-- Necesario para actualizar en controlador la fila seleccionada -->
                        <p:ajax event="rowSelect" global="false"/>
                        <p:ajax event="rowUnselect"/>
                        <p:ajax
                                event="rowDblselect"
                                oncomplete="triggerDblClickUA();"
                                global="false"/>


                        <p:column headerText="#{labels['msg.tablaVacia']}" styleClass="text-center w75">
                            <h:outputText value="#{td.nombre.getTraduccion(dialogNormativa.idioma)}"/>
                        </p:column>

                    </p:dataTable>
                </div>
                <div class="col-2 p-1 d-flex flex-column align-content-center justify-content-center align-items-center">
                    <p:commandButton title="#{labels['dict.nuevo']}" icon="pi pi-plus" styleClass="text-success"
                                     process="@this" actionListener="#{dialogNormativa.anyadirUAs()}"
                                     rendered="#{!dialogNormativa.isModoConsulta()}">
                        <p:ajax event="dialogReturn" listener="#{dialogNormativa.returnDialogoUAs}" process="@this"
                                update="messagesDialog dataTableUAs"/>
                    </p:commandButton>
                    <p:commandButton title="#{labels['dict.eliminar']}" icon="pi pi-minus" styleClass="text-danger"
                                     action="#{dialogNormativa.borrarUA()}"
                                     process="@this" update="dataTableUAs messagesDialog"
                                     rendered="#{!dialogNormativa.isModoConsulta()}"/>
                    <p:commandButton id="btnConsultarUA" title="#{labels['dict.consultar']}" icon="pi pi-eye"
                                     action="#{dialogNormativa.consultarUA()}"
                                     process="@this" update="dataTableUAs messagesDialog"/>
                </div>
            </div>
            <div class="row left-container mx-0 mb-2">
                <div class="col-12 left-container-header text-center">
                    <p class="left-container-tit mt-2 mb-1">#{labels['dialogNormativa.procedimientos']}</p>
                </div>
                <div class="col-10 p-1">
                    <p:dataTable id="dataProcedimientosRelacionados" var="td"
                                 value="#{dialogNormativa.procedimientosRelacionados}"
                                 emptyMessage="#{labels['dict.tablaVacia']}" scrollable="true" scrollHeight="120"
                                 paginator="false" selectionMode="single"
                                 selection="#{dialogNormativa.procSeleccionado}"
                                 rowKey="#{td.codigo}"
                                 styleClass="noHeader text-center">

                        <!-- Necesario para actualizar en controlador la fila seleccionada -->
                        <p:ajax
                                event="rowDblselect"
                                oncomplete="triggerDblClickProc();"
                                global="false"/>
                        <p:ajax event="rowSelect" global="false"/>
                        <p:ajax event="rowUnselect"/>


                        <p:column headerText="#{labels['dict.nombre']}" styleClass="w75">
                            <h:outputText value="#{td.nombre.getTraduccion(dialogNormativa.idioma)}"/>
                        </p:column>

                    </p:dataTable>
                </div>
                <div class="col-2 p-1 d-flex flex-column align-content-center justify-content-center align-items-center">
                    <p:commandButton id="btnConsultarProc" title="#{labels['dict.consultar']}" icon="pi pi-eye"
                                     action="#{dialogNormativa.consultarProcs()}"
                                     process="@this" update="dataProcedimientosRelacionados messagesDialog"/>
                </div>
            </div>
            <div class="row left-container mx-0 mb-2">
                <div class="col-12 left-container-header text-center">
                    <p class="left-container-tit mt-2 mb-1">#{labels['dialogNormativa.servicios']}</p>
                </div>
                <div class="col-10 p-1">
                    <p:dataTable id="dataServiciosRelacionados" var="td"
                                 value="#{dialogNormativa.serviciosRelacionados}"
                                 emptyMessage="#{labels['dict.tablaVacia']}" scrollable="true" scrollHeight="120"
                                 paginator="false" selectionMode="single"
                                 selection="#{dialogNormativa.servicioSeleccionado}"
                                 rowKey="#{td.codigo}"
                                 styleClass="noHeader text-center">

                        <!-- Necesario para actualizar en controlador la fila seleccionada -->
                        <p:ajax event="rowSelect" global="false"/>
                        <p:ajax event="rowSelect" global="false"/>
                        <p:ajax event="rowUnselect"/>
                        <p:ajax
                                event="rowDblselect"
                                oncomplete="triggerDblClickServ();"
                                global="false"/>

                        <p:column headerText="#{labels['dict.descripcion']}" styleClass="w75">
                            <h:outputText value="#{td.nombre.getTraduccion(dialogNormativa.idioma)}"/>
                        </p:column>

                    </p:dataTable>
                </div>
                <div class="col-2 p-1 d-flex flex-column align-content-center justify-content-center align-items-center">
                    <p:commandButton id="btnConsultarServ" title="#{labels['dict.consultar']}" icon="pi pi-eye"
                                     action="#{dialogNormativa.consultarServicio()}"
                                     process="@this" update="dataServiciosRelacionados messagesDialog"/>
                </div>
            </div>
            <div class="row left-container mx-0 mb-2">
                <div class="col-12 left-container-header text-center">
                    <p class="left-container-tit mt-2 mb-1">#{labels['dialogNormativa.afectaciones']}</p>
                </div>
                <div class="col-10 p-1">
                    <p:dataTable id="dataAfectacionesRelacionadas" var="td" value="#{dialogNormativa.data.afectaciones}"
                                 emptyMessage="No hay afectaciones relacionadas" scrollable="true" scrollHeight="120"
                                 paginator="false" styleClass="text-center" selectionMode="single"
                                 selection="#{dialogNormativa.afectacionSeleccionada}"
                                 rowKey="#{td.codigoTabla}">

                        <!-- Necesario para actualizar en controlador la fila seleccionada -->
                        <p:ajax event="rowSelect" global="false"/>
                        <p:ajax event="rowSelect" global="false"/>
                        <p:ajax event="rowUnselect"/>
                        <p:ajax event="rowDblselect"
                                oncomplete="triggerDblClickAfect();"
                        />

                        <p:column headerText="#{labels['dialogNormativa.tipoAfectacion']}" styleClass="w75">
                            <h:outputText value="#{td.tipo.descripcion.getTraduccion(dialogNormativa.idioma)}"/>
                        </p:column>
                        <p:column headerText="#{labels['dialogNormativa.normativaOrigen']}" styleClass="w75">
                            <h:outputText value="#{td.normativaOrigen.titulo.getTraduccion(dialogNormativa.idioma)}"/>
                        </p:column>


                    </p:dataTable>
                </div>
                <div class="col-2 p-1 d-flex flex-column align-content-center justify-content-center align-items-center">
                    <p:commandButton id="btnAbrirAfect" title="#{labels['dict.nuevo']}" icon="pi pi-plus"
                                     styleClass="text-success"
                                     process="@this" actionListener="#{dialogNormativa.abrirAfectacion}"
                                     rendered="#{!dialogNormativa.isModoConsulta()}">
                        <p:ajax event="dialogReturn" listener="#{dialogNormativa.returnDialogoAfectacion}"
                                process="@this"
                                update="messagesDialog dataAfectacionesRelacionadas"/>
                    </p:commandButton>
                    <p:commandButton title="#{labels['dict.eliminar']}" icon="pi pi-minus" styleClass="text-danger"
                                     action="#{dialogNormativa.borrarAfectacion()}"
                                     process="@this" update="dataAfectacionesRelacionadas messagesDialog"
                                     rendered="#{!dialogNormativa.isModoConsulta()}"/>
                    <p:commandButton id="btnConsultarAfect" title="#{labels['dict.consultar']}" icon="pi pi-eye"
                                     action="#{dialogNormativa.consultarAfectacion()}"
                                     process="@this" update="dataAfectacionesRelacionadas messagesDialog"/>
                </div>
            </div>
        </div>

        <h:outputScript>
            function triggerDblClickDoc() {
                document.getElementById("formDialog:btnEditarDoc").click();
            }

            function triggerDblClickUA() {
                document.getElementById("formDialog:btnConsultarUA").click();
            }

            function triggerDblClickProc() {
                document.getElementById("formDialog:btnConsultarProc").click();
            }

            function triggerDblClickAfect() {
                document.getElementById("formDialog:btnAbrirAfect").click();
            }

            function triggerDblClickServ() {
                document.getElementById("formDialog:btnConsultarServ").click();
            }
        </h:outputScript>
        <p:remoteCommand name="myDoubleClickCommand"
                         widgetVar="myDoubleClickCommand"
                         action="#{dialogNormativa.editarDocumentoRelacionado()}"
                         autoRun="false"
                         partialSubmit="true"
                         process="@this"/>
    </ui:define>
    <ui:define name="contentFooterDialogRight">
        <p:commandButton action="#{dialogNormativa.ayuda}"
                         icon="pi pi-info-circle" iconPos="top"
                         value="#{labels['dict.ayuda']}"
                         process="@this"/>
        <p:commandButton action="#{dialogNormativa.guardar}"
                         value="#{labels['dict.guardar']}" update="messagesDialog formPublicacion formDatos"
                         rendered="#{!dialogNormativa.isModoConsulta()}"
                         process="@all"/>
        <p:commandButton action="#{dialogNormativa.cerrar}" id="closeButton"
                         value="#{labels['dict.cerrar']}" update="messagesDialog"
                         process="@all" oncomplete="stopCargando()" onstart="startCargando()"/>
        <p:confirmDialog showEffect="fade" hideEffect="fade" header="#{labels['dict.cerrar.cambiosSinGuardar.titulo']}"
                         update="messagesDialog form" responsive="true" width="458px"
                         message="#{labels['dict.cerrar.cambiosSinGuardar.mensaje']}" widgetVar="confirmCerrar">
            <p:commandButton value="SÃ­" process="@this" action="#{dialogNormativa.cerrarDefinitivo}"
                             oncomplete="PF('confirmCerrar').hide();"/>
            <p:commandButton value="No" onclick="PF('confirmCerrar').hide();"/>
        </p:confirmDialog>
    </ui:define>
</ui:composition>
</html>