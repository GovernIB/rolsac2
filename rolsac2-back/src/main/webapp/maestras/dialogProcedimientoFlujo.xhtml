<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:p="http://primefaces.org/ui"
      xmlns:c="http://xmlns.jcp.org/jsp/jstl/core"
>
<ui:composition template="/WEB-INF/templates/layoutDialog.xhtml">
    <ui:define name="metadata">
        <f:metadata>
            <f:viewParam id="MODO_ACCESO" name="MODO_ACCESO" value="#{dialogProcedimientoFlujo.modoAcceso}"/>
            <f:viewParam id="ID" name="ID" value="#{dialogProcedimientoFlujo.id}"/>
            <f:viewParam id="SOLO_MENSAJES" name="SOLO_MENSAJES" value="#{dialogProcedimientoFlujo.consultarSoloMensajes}"/>
            <f:viewParam id="ESTADO" name="ESTADO" value="#{dialogProcedimientoFlujo.estadoActual}"/>
            <f:viewAction action="#{dialogProcedimientoFlujo.load}"/>
        </f:metadata>
    </ui:define>
    <ui:define name="pageTitleDialog">
        <h:outputFormat value="#{labels['dialogProcedimientoFlujo.detalle']}" />
    </ui:define>
    <ui:define name="contentDialog">
        <p:growl id="messagesDialog"
                 globalOnly="false"
                 showDetail="false"
                 life="5000"
                 escape="false"/>

        <h:outputStylesheet>
            .myTable thead {
                display:none;
            }
        </h:outputStylesheet>
        <p:panel header="#{labels['dialogProcedimientoFlujo.datos']}" id="formDatos">
            <div class="row">
                <c:if test="#{!empty dialogProcedimientoFlujo.estados}">
                    <div class="ui-g-12 ui-md-1 ui-lg-1">
                        <p:outputLabel value="#{labels['dict.estadoDestino']}:" for="datatableEstado" rendered="#{!empty dialogProcedimientoFlujo.estados }"/>
                    </div>
                    <div class="ui-g-12 ui-md-5 ui-lg-5">
                        <p:dataTable id="datatableEstado" var="td" value="#{dialogProcedimientoFlujo.estados}"
                                     rows="25" scrollable="true" style=" margin-right:0px !important;  flex: 1;" styleClass=".myTable"
                                     paginator="false" selectionMode="single"
                                     required="true"
                                     rendered="#{!empty dialogProcedimientoFlujo.estados}"
                                     disabled="#{!dialogProcedimientoFlujo.mostrarEstados}"
                                     selection="#{dialogProcedimientoFlujo.estadoSeleccionado}" rowKey="#{td.toString()}">

                            <!-- Necesario para actualizar en controlador la fila seleccionada -->
                            <p:ajax event="rowSelect" global="false"/>
                            <p:ajax event="rowUnselect"/>

                            <!-- Columnas -->
                            <p:column class="ui-panelgrid-cell">
                                <h:outputText value="#{labels['TypeProcedimientoEstado.' += td.toString()]}"/>
                            </p:column>


                        </p:dataTable>
                    </div>
                </c:if>
                <div class="ui-g-12 ui-md-1 ui-lg-1">
                    <h:outputText value="#{labels['dict.mensaje']}:" for="datatableEstado"/>
                </div>
                <div class="ui-g-12 ui-md-5 ui-lg-5">
                    <p:inputTextarea value="#{dialogProcedimientoFlujo.mensajeNuevo}" rows="5" cols="35"   autoResize="false">
                        <p:keyFilter regEx="/[0-9_-a-zA-Z\u00C0-\u024F\. @!¡()¿?+-;:,]/i" preventPaste="false"/>
                    </p:inputTextarea>
                </div>
            </div>
        </p:panel>
        <p:panel header="#{labels['dialogProcedimientoFlujo.historial']}" id="formDatos2">
            <div class="row">
                <div class="ui-g-12 ui-md-12 ui-lg-12 d-flex w100">
                    <table style="padding:5px;width: 100%">
                    <thead>
                    <tr>
                        <th scope="col" width="10%" style="padding:10px"></th>
                        <th scope="col" width="10%" style="padding:10px">#{labels['dialogProcedimientoFlujo.admContenido']}</th>
                        <th scope="col" width="40%" style="padding:10px">#{labels['dialogProcedimientoFlujo.mensaje']}</th>
                        <th scope="col" width="20%" style="padding:10px">#{labels['dialogProcedimientoFlujo.fecha']}</th>
                        <th scope="col" width="10%" style="padding:10px">#{labels['dialogProcedimientoFlujo.gestor']}</th>
                        <th scope="col" width="10%" style="padding:10px"></th>
                    </tr>
                    </thead>
                    <tbody>

                        <ui:repeat var="mensaje" value="#{dialogProcedimientoFlujo.mensajes}" varStatus="status" >
                            <tr >
                                <ui:fragment rendered="#{dialogProcedimientoFlujo.esAdministradorContenido(mensaje)}">
                                    <td>
                                        <p:commandButton action="#{dialogProcedimientoFlujo.marcarComoLeido(status.index)}"
                                                         value="#{labels['dict.marcarComoLeido']}"
                                                         icon="pi pi-check" update="@form:formDatos2"
                                                         rendered="#{dialogProcedimientoFlujo.isAdministradorContenidos() and mensaje.isPendienteMensajesSupervisor()}"
                                                         process="@this"/>
                                    </td>
                                    <td class="backgroundAdmContenido borderIzqArribaAbajo" style="padding: 10px;">#{mensaje.usuario}</td>
                                    <td class="backgroundAdmContenido borderArribaAbajo" style="padding: 20px;">#{mensaje.mensaje}</td>
                                    <td class="backgroundAdmContenido borderDerArribaAbajo" style="padding: 10px;">
                                        <h:outputText value="#{mensaje.fechaReal}">
                                            <f:convertDateTime type="date" pattern="dd/MM/yyyy HH:mm"/>
                                        </h:outputText>
                                    </td>
                                    <td></td>
                                    <td>
                                            <p:commandButton action="#{dialogProcedimientoFlujo.marcarComoLeido(status.index)}"
                                                             value="#{labels['dict.marcarComoLeido']}"
                                                             icon="pi pi-check" update="@form:formDatos2"
                                                             rendered="#{dialogProcedimientoFlujo.isGestor() and mensaje.isPendienteMensajesGestor()}"
                                                             process="@this"/>
                                    </td>
                                </ui:fragment>
                                <ui:fragment rendered="#{!dialogProcedimientoFlujo.esAdministradorContenido(mensaje)}">
                                    <td>
                                            <p:commandButton action="#{dialogProcedimientoFlujo.marcarComoLeido(status.index)}"
                                                             value="#{labels['dict.marcarComoLeido']}"
                                                             icon="pi pi-check" update="@form:formDatos2"
                                                             rendered="#{dialogProcedimientoFlujo.isAdministradorContenidos() and mensaje.isPendienteMensajesSupervisor()}"
                                                             process="@this"/>

                                    </td>
                                    <td style="border-top:none !important;"></td>
                                    <td class="backgroundGestor borderIzqArribaAbajo" style="padding: 20px;">#{mensaje.mensaje}</td>
                                    <td class="backgroundGestor borderArribaAbajo" style="padding: 10px;">
                                        <h:outputText value="#{mensaje.fechaReal}">
                                            <f:convertDateTime type="date" pattern="dd/MM/yyyy HH:mm"/>
                                        </h:outputText>
                                    </td>
                                    <td class="backgroundGestor borderDerArribaAbajo" style="padding: 10px;">#{mensaje.usuario}</td>
                                    <td>
                                            <p:commandButton action="#{dialogProcedimientoFlujo.marcarComoLeido(status.index)}"
                                                             value="#{labels['dict.marcarComoLeido']}"
                                                             icon="pi pi-check" update="@form:formDatos2"
                                                             rendered="#{dialogProcedimientoFlujo.isGestor() and mensaje.isPendienteMensajesGestor()}"
                                                             process="@this"/>
                                    </td>
                                </ui:fragment>

                            </tr>
                            <tr style="height:5px">
                                <td colspan="4" height="5px"></td>

                            </tr>
                        </ui:repeat>
                    </tbody>
                    </table>
                </div>
            </div>
        </p:panel>
    </ui:define>
    <ui:define name="contentFooterDialogRight">
        <p:commandButton action="#{dialogProcedimientoFlujo.ayuda}"
                         icon="pi pi-info-circle" iconPos="top"
                         value="#{labels['dict.ayuda']}"
                         process="@this"/>
        <p:commandButton action="#{dialogProcedimientoFlujo.guardar}"
                         value="#{labels['dict.guardar']}" update="messagesDialog formDatos"
                         process="@all"/>
        <p:commandButton action="#{dialogProcedimientoFlujo.cerrar}"
                         value="#{labels['dict.cerrar']}"
                         process="@this"/>
    </ui:define>
</ui:composition>
</html>